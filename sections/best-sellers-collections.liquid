{%- assign bs_uid = section.id | replace: '_','' | downcase -%}

<section class="best-sellers-section best-sellers-{{ bs_uid }}" 
         style="background-color: {{ section.settings.background_color }}; 
                padding: {{ section.settings.section_padding_top }}px 20px {{ section.settings.section_padding_bottom }}px 20px;"
         aria-labelledby="best-sellers-title-{{ bs_uid }}">
  
  <!-- Unified max-width wrapper -->
  <div class="best-sellers-container"
       style="max-width: 1280px; width: 100%; margin: 0 auto; background-color: {{ section.settings.container_background_color }};">

    <!-- Section Header -->
    <header class="section-header" 
            style="margin-bottom: {{ section.settings.title_bottom_spacing }}px; position: relative;">
      
      {% if section.settings.show_badge and section.settings.badge_image %}
      <div class="collection-badge collection-badge--center" role="img" aria-label="{{ section.settings.badge_alt | default: 'Collection Badge' }}">
        <img src="{{ section.settings.badge_image | image_url: width: 200 }}" 
             alt="{{ section.settings.badge_alt | default: 'Collection Badge' }}" 
             class="badge-image {% if section.settings.badge_spin %}badge-spin{% endif %}"
             style="width: {{ section.settings.badge_size }}px; height: {{ section.settings.badge_size }}px;"
             width="{{ section.settings.badge_size }}"
             height="{{ section.settings.badge_size }}"
             loading="lazy"
             decoding="async">
      </div>
      {% endif %}
      
      {% if section.settings.section_title != blank %}
      <h3 id="best-sellers-title-{{ bs_uid }}" 
          class="section-title h2"
          style="color: {{ section.settings.title_color }};">
        {{ section.settings.section_title }}
      </h3>
      {% else %}
      <h3 id="best-sellers-title-{{ bs_uid }}" class="sr-only">Best Sellers</h3>
      {% endif %}
    </header>
    
    <!-- Products Grid -->
    {% if section.settings.collection != blank %}
      {% assign collection = collections[section.settings.collection] %}
      {% if collection.products.size > 0 %}
      <div class="products-grid {% if section.settings.enable_image_float %}enable-image-float-{{ bs_uid }}{% endif %}" 
           style="grid-template-columns: repeat(auto-fit, minmax({{ section.settings.min_product_width }}px, 1fr)); gap: {{ section.settings.products_grid_gap }}px;">
        
        {% for product in collection.products limit: section.settings.products_to_show %}
        <article class="product-card"
                 style="background-color: {{ section.settings.card_background }}; 
                        border-radius: {{ section.settings.card_border_radius }}px;">
          
          <!-- Product Image -->
          <div class="product-image-container{% if section.settings.enable_image_float %} image-float{% endif %}"
               style="--float-offset: {{ section.settings.image_float_offset }}px;">
            
            {%- assign first_image = product.featured_image | default: product.images.first -%}
            {%- assign second_image = product.images[1] -%}

            <a href="{{ product.url }}" 
               aria-label="View {{ product.title }}"
               class="product-link">
              
              <div class="product-image-wrap">
                {% if first_image %}
                  <img
                    src="{{ first_image | image_url: width: 400 }}"
                    srcset="{{ first_image | image_url: width: 200 }} 200w,
                            {{ first_image | image_url: width: 300 }} 300w,
                            {{ first_image | image_url: width: 400 }} 400w"
                    sizes="(max-width: 480px) 200px, (max-width: 768px) 300px, 400px"
                    alt="{{ first_image.alt | default: product.title }}"
                    class="product-image product-image--primary"
                    width="400" height="400"
                    loading="lazy" decoding="async">
                {% else %}
                  <div class="product-image-placeholder" 
                       style="background-color: {{ section.settings.placeholder_color }};"
                       aria-label="No image available for {{ product.title }}">
                    <span aria-hidden="true">No Image</span>
                  </div>
                {% endif %}

                {% if second_image %}
                  <img
                    src="{{ second_image | image_url: width: 400 }}"
                    srcset="{{ second_image | image_url: width: 200 }} 200w,
                            {{ second_image | image_url: width: 300 }} 300w,
                            {{ second_image | image_url: width: 400 }} 400w"
                    sizes="(max-width: 480px) 200px, (max-width: 768px) 300px, 400px"
                    alt=""
                    aria-hidden="true"
                    class="product-image product-image--secondary"
                    width="400" height="400"
                    loading="lazy" decoding="async">
                {% endif %}
              </div>

              <!-- Product Badge/Sale -->
              {% if product.compare_at_price > product.price %}
              <span class="sale-badge" 
                    style="background-color: {{ section.settings.sale_badge_color }};"
                    aria-label="On sale">
                Sale
              </span>
              {% endif %}
            </a>
          </div>
          
          <!-- Product Info -->
          <div class="product-info" style="padding: {{ section.settings.card_padding }}px;">
            
            {% if section.settings.show_ratings %}
            <div class="product-rating" aria-label="5 out of 5 stars">
              {% for i in (1..5) %}
                <span class="star"
                      style="color: {{ section.settings.star_color }};"
                      aria-hidden="true">â˜…</span>
              {% endfor %}
            </div>
            {% endif %}
            
            {% if section.settings.show_vendor and product.vendor %}
            <p class="product-vendor" 
               style="color: {{ section.settings.vendor_color }};">
              {{ product.vendor }}
            </p>
            {% endif %}
            
            <h4 class="product-title h4">
              <a href="{{ product.url }}" 
                 style="color: {{ section.settings.product_title_color }};">
                {{ product.title }}
              </a>
            </h4>
            
            <form action="/cart/add" method="post" enctype="multipart/form-data" class="product-form">
              {% unless product.has_only_default_variant %}
                <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
              {% else %}
                <input type="hidden" name="id" value="{{ product.variants.first.id }}">
              {% endunless %}
              
              <button type="submit" 
                      class="add-to-cart-btn {% unless product.available %}sold-out{% endunless %}"
                      style="background-color: {{ section.settings.cart_button_background }}; 
                             color: {{ section.settings.cart_button_text_color }};
                             border-radius: {{ section.settings.cart_button_radius }}px;"
                      {% unless product.available %}disabled{% endunless %}
                      aria-label="Add {{ product.title }} to cart">
                {% if product.available %}
                  {{ section.settings.add_to_cart_text | default: 'ADD TO CART' }}
                {% else %}
                  {{ section.settings.sold_out_text | default: 'SOLD OUT' }}
                {% endif %}
              </button>
            </form>
          </div>
        </article>
        {% endfor %}
        
      </div>
      {% else %}
      <div class="no-products-message" 
           style="text-align: center; padding: 40px; color: #666;">
        <p>No products found in this collection.</p>
      </div>
      {% endif %}
      
      {% if section.settings.show_see_all_button and section.settings.collection != blank %}
      <div class="see-all-container" 
           style="text-align: {{ section.settings.button_alignment }}; margin-top: {{ section.settings.button_top_spacing }}px;">
        <!-- Secondary filled button with sliding arrow -->
        <a href="{{ collections[section.settings.collection].url }}" 
           class="seeall-btn btn-arrow"
           aria-label="See all products in {{ collections[section.settings.collection].title }} collection">
          <span class="seeall-btn__content">
            {{ section.settings.see_all_text | default: 'See all products' }}
            <svg class="seeall-btn__arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36.1 25.8" aria-hidden="true" focusable="false">
              <g>
                <line fill="none" stroke="currentColor" stroke-width="3" stroke-miterlimit="10" x1="0" y1="12.9" x2="34" y2="12.9"></line>
                <polyline fill="none" stroke="currentColor" stroke-width="3" stroke-miterlimit="10" points="22.2,1.1 34,12.9 22.2,24.7"></polyline>
              </g>
            </svg>
          </span>
        </a>
      </div>
      {% endif %}
      
    {% else %}
    <div class="no-collection-message" 
         style="text-align: center; padding: 40px; color: #666;">
      <p>Please select a collection to display products.</p>
    </div>
    {% endif %}
    
  </div>
</section>

<style>
.best-sellers-{{ bs_uid }} .section-title,
.best-sellers-{{ bs_uid }} .product-title { font-weight: 600; margin: 0; }

/* Ensure the whole section sits under header elements */
.best-sellers-{{ bs_uid }} { position: relative; z-index: 0; }

/* Container: max-width + make children span full width */
.best-sellers-{{ bs_uid }} .best-sellers-container {
  position: relative;
  width: 100%;
  max-width: 1280px;
  padding: 80px 40px;
  margin: 0 auto;
}
.best-sellers-{{ bs_uid }} .section-header,
.best-sellers-{{ bs_uid }} .products-grid,
.best-sellers-{{ bs_uid }} .see-all-container { width: 100%; }

/* Badge (centered above title) */
.best-sellers-{{ bs_uid }} .collection-badge {
  position: static !important;
  display: flex; justify-content: center; align-items: center;
  margin: 0 auto 12px auto; width: auto;
}
.best-sellers-{{ bs_uid }} .badge-image { border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,.1); display: block; }
.best-sellers-{{ bs_uid }} .badge-spin { animation: spin {{ section.settings.badge_spin_speed | default: 10 }}s linear infinite; }
@keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
@media (prefers-reduced-motion: reduce) { .best-sellers-{{ bs_uid }} .badge-spin { animation: none; } }

/* Grid */
.best-sellers-{{ bs_uid }} .products-grid { display: grid; margin-bottom: 20px; }

/* Product Card */
.best-sellers-{{ bs_uid }} .product-card {
  position: relative; overflow: visible;
  transition: transform .3s ease, box-shadow .3s ease;
  height: 100%; display: flex; flex-direction: column;
}
.best-sellers-{{ bs_uid }} .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,.15); }

/* Product Image container */
.best-sellers-{{ bs_uid }} .product-image-container { position: relative; aspect-ratio: 1/1; overflow: hidden; background-color: #f8f8f8; }
.best-sellers-{{ bs_uid }} .product-image-container.image-float { transform: translateY(calc(var(--float-offset) * -1)); margin-bottom: calc(var(--float-offset) * -1); }
.best-sellers-{{ bs_uid }} .product-link { display:block; width:100%; height:100%; }

/* --- Image swap stack --- */
.best-sellers-{{ bs_uid }} .product-image-wrap { position: relative; width: 100%; height: 100%; }
.best-sellers-{{ bs_uid }} .product-image {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  object-fit: cover; object-position: center;
  transition: opacity .3s ease, transform .3s ease;
}
.best-sellers-{{ bs_uid }} .product-image--primary { opacity: 1; }
.best-sellers-{{ bs_uid }} .product-image--secondary { opacity: 0; }
.best-sellers-{{ bs_uid }} .product-card:hover .product-image--secondary { opacity: 1; }
.best-sellers-{{ bs_uid }} .product-card:hover .product-image--primary { opacity: 0; }
.best-sellers-{{ bs_uid }} .product-card:hover .product-image--primary,
.best-sellers-{{ bs_uid }} .product-card:hover .product-image--secondary { transform: scale(1.05); }

/* Placeholder */
.best-sellers-{{ bs_uid }} .product-image-placeholder { width: 100%; height: 100%; display:flex; align-items:center; justify-content:center; color:#999; }

/* Badges */
.best-sellers-{{ bs_uid }} .sale-badge { position:absolute; top:10px; left:10px; color:#fff; padding:5px 10px; border-radius:4px; }

/* Info area */
.best-sellers-{{ bs_uid }} .product-info { flex:1; display:flex; flex-direction:column; gap:10px; }
.best-sellers-{{ bs_uid }} .product-rating { display:flex; gap:2px; margin-bottom:5px; }
.best-sellers-{{ bs_uid }} .product-vendor { margin:0; }
.best-sellers-{{ bs_uid }} .product-title { margin:0; flex:1; }
.best-sellers-{{ bs_uid }} .product-title a { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }

/* Add to Cart */
.best-sellers-{{ bs_uid }} .product-form { margin-top:auto; }
.best-sellers-{{ bs_uid }} .add-to-cart-btn { width:100%; border:0; padding:12px 20px; cursor:pointer; transition: all .3s ease; }
.best-sellers-{{ bs_uid }} .add-to-cart-btn:focus { outline:2px solid currentColor; outline-offset:2px; }
.best-sellers-{{ bs_uid }} .add-to-cart-btn.sold-out { opacity:.6; cursor:not-allowed; }
/* Requested Add-to-cart hover color */
.best-sellers-{{ bs_uid }} .add-to-cart-btn:hover:not(.sold-out) {
  background-color: #1FC2DB !important;
}

/* === See all button === */
.best-sellers-{{ bs_uid }} .seeall-btn {
  --btn-color: #2D0288;
  display: inline-flex;
  align-items: center;
  color: #ffffff;
  background: #2D0288;
  text-decoration: none;
  padding: 14px 40px;
  border-radius: 25px;
  min-width: 200px;
  font-family: inherit;
  font-size: 18px;
  font-weight: 400;
  letter-spacing: 1.5px;    
  line-height: 1;
  position: relative;
  overflow: hidden;
  transition: color .1s cubic-bezier(0.16, 0.08, 0.355, 1), 
              background .1s cubic-bezier(0.16, 0.08, 0.355, 1),
              border-color .1s cubic-bezier(0.16, 0.08, 0.355, 1);
}
.best-sellers-{{ bs_uid }} .seeall-btn:hover,
.best-sellers-{{ bs_uid }} .seeall-btn:focus {
  background: #2D0288;
  color: #ffffff;
}
.best-sellers-{{ bs_uid }} .seeall-btn:focus-visible {
  outline: 2px solid var(--btn-color);
  outline-offset: 2px;
}
.best-sellers-{{ bs_uid }} .seeall-btn__content {
  display: inline-block;
  position: relative;
  transition: transform 300ms ease-out;
  will-change: transform;
}
.best-sellers-{{ bs_uid }} .seeall-btn.btn-arrow:hover .seeall-btn__content,
.best-sellers-{{ bs_uid }} .seeall-btn.btn-arrow:focus .seeall-btn__content {
  transform: translate3d(-0.8rem, 0, 0);
}
.best-sellers-{{ bs_uid }} .seeall-btn__arrow {
  position: absolute;
  width: 1.1em;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  opacity: 0;
  transition: right 300ms ease-out, opacity 300ms ease-out;
  will-change: right, opacity;
  color: currentColor;
}
.best-sellers-{{ bs_uid }} .seeall-btn.btn-arrow:hover .seeall-btn__arrow,
.best-sellers-{{ bs_uid }} .seeall-btn.btn-arrow:focus .seeall-btn__arrow {
  opacity: 1;
  right: -1.8rem;
}

/* Responsive */
@media (max-width: 768px) {

  .best-sellers-section {
    padding: 0 !important;
  }
  /* Requested mobile padding */
  .best-sellers-{{ bs_uid }} .best-sellers-container { padding: 120px 16px }

  /* Center the heading on mobile */
  .best-sellers-{{ bs_uid }} .section-header { 
    margin-bottom: 30px; 
    text-align: center; 
  }

  /* Center the See All button regardless of desktop alignment setting */
  .best-sellers-{{ bs_uid }} .see-all-container { 
    margin-top: 30px !important; 
    text-align: center !important; 
  }

  .best-sellers-{{ bs_uid }} .badge-image {
    width: calc({{ section.settings.badge_size | default: 120 }}px * .8) !important;
    height: calc({{ section.settings.badge_size | default: 120 }}px * .8) !important;
  }

  .best-sellers-{{ bs_uid }} .products-grid { 
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)) !important; 
    gap: 64px !important; 
  }
}

@media (max-width: 480px) { 
  .best-sellers-{{ bs_uid }} .products-grid { grid-template-columns: 1fr !important; }
}

/* SR-only */
.best-sellers-{{ bs_uid }} .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

/* Navbar safety */
.best-sellers-{{ bs_uid }} .section-header,
.best-sellers-{{ bs_uid }} .collection-badge { position: relative; z-index: 1; }
</style>

{% schema %}
{
  "name": "Best Sellers Collection",
  "settings": [
    { "type": "header", "content": "Collection Settings" },
    { "type": "collection", "id": "collection", "label": "Collection", "info": "Select the collection to display products from" },
    { "type": "range", "id": "products_to_show", "label": "Number of Products to Show", "min": 1, "max": 12, "step": 1, "default": 3 },
    { "type": "range", "id": "min_product_width", "label": "Minimum Product Card Width", "info": "Controls responsive breakpoints", "min": 200, "max": 350, "step": 25, "default": 275, "unit": "px" },

    { "type": "header", "content": "Section Layout" },
    { "type": "color", "id": "background_color", "label": "Section Background Color", "default": "#f8f8f8" },
    { "type": "color", "id": "container_background_color", "label": "Inner Container Background", "default": "transparent" },
    { "type": "range", "id": "section_padding_top", "label": "Section Padding Top", "min": 0, "max": 100, "step": 5, "default": 60, "unit": "px" },
    { "type": "range", "id": "section_padding_bottom", "label": "Section Padding Bottom", "min": 0, "max": 100, "step": 5, "default": 60, "unit": "px" },

    { "type": "header", "content": "Section Title" },
    { "type": "text", "id": "section_title", "label": "Section Title", "default": "Our Best Sellers" },
    { "type": "color", "id": "title_color", "label": "Title Color", "default": "#8b1538" },
    { "type": "range", "id": "title_bottom_spacing", "label": "Space Below Title", "info": "Vertical spacing between title and products", "min": 20, "max": 80, "step": 5, "default": 40, "unit": "px" },

    { "type": "header", "content": "Product Grid Spacing" },
    { "type": "range", "id": "products_grid_gap", "label": "Gap Between Products", "info": "Horizontal and vertical spacing between product cards", "min": 15, "max": 60, "step": 5, "default": 30, "unit": "px" },

    { "type": "header", "content": "Image Float (Overflow)" },
    { "type": "checkbox", "id": "enable_image_float", "label": "Allow product images to overflow above card", "default": true },
    { "type": "range", "id": "image_float_offset", "label": "Overflow amount (px)", "min": 0, "max": 80, "step": 5, "default": 25, "unit": "px" },

    { "type": "header", "content": "See All Button" },
    { "type": "checkbox", "id": "show_see_all_button", "label": "Show 'See All' Button", "default": true },
    { "type": "text", "id": "see_all_text", "label": "Button Text", "default": "See all" },
    { "type": "select", "id": "button_alignment", "label": "Button Alignment", "options": [
      { "value": "left", "label": "Left" },
      { "value": "center", "label": "Center" },
      { "value": "right", "label": "Right" }
    ], "default": "center" },
    { "type": "range", "id": "button_top_spacing", "label": "Space Above Button", "min": 20, "max": 80, "step": 5, "default": 40, "unit": "px" },
    { "type": "checkbox", "id": "see_all_add_padding", "label": "Use blog-style padding (ctm-btn-padding)", "default": false },

    { "type": "header", "content": "Badge Settings" },
    { "type": "checkbox", "id": "show_badge", "label": "Show Badge", "default": true },
    { "type": "image_picker", "id": "badge_image", "label": "Badge Image" },
    { "type": "text", "id": "badge_alt", "label": "Badge Alt Text", "default": "100% Fun Guaranteed" },
    { "type": "range", "id": "badge_size", "label": "Badge Size", "min": 80, "max": 150, "step": 10, "default": 120, "unit": "px" },
    { "type": "checkbox", "id": "badge_spin", "label": "Enable Badge Spinning", "default": false },
    { "type": "range", "id": "badge_spin_speed", "label": "Spin Speed (seconds)", "min": 5, "max": 20, "step": 1, "default": 10, "unit": "s" },

    { "type": "header", "content": "Product Cards" },
    { "type": "color", "id": "card_background", "label": "Card Background", "default": "#ffffff" },
    { "type": "range", "id": "card_border_radius", "label": "Card Border Radius", "min": 0, "max": 30, "step": 5, "default": 15, "unit": "px" },
    { "type": "range", "id": "card_padding", "label": "Card Content Padding", "min": 15, "max": 35, "step": 5, "default": 20, "unit": "px" },
    { "type": "color", "id": "placeholder_color", "label": "Image Placeholder Color", "default": "#f0f0f0" },
    { "type": "color", "id": "sale_badge_color", "label": "Sale Badge Color", "default": "#ff4444" },

    { "type": "header", "content": "Product Information" },
    { "type": "checkbox", "id": "show_ratings", "label": "Show Star Ratings", "default": true },
    { "type": "color", "id": "star_color", "label": "Star Color", "default": "#ffc107" },
    { "type": "checkbox", "id": "show_vendor", "label": "Show Brand/Vendor", "default": true },
    { "type": "color", "id": "vendor_color", "label": "Brand Color", "default": "#666666" },
    { "type": "color", "id": "product_title_color", "label": "Product Title Color", "default": "#333333" },

    { "type": "header", "content": "Add to Cart Button" },
    { "type": "text", "id": "add_to_cart_text", "label": "Add to Cart Text", "default": "ADD TO CART" },
    { "type": "text", "id": "sold_out_text", "label": "Sold Out Text", "default": "SOLD OUT" },
    { "type": "color", "id": "cart_button_background", "label": "Button Background", "default": "#ff69b4" },
    { "type": "color", "id": "cart_button_text_color", "label": "Button Text Color", "default": "#ffffff" },
    { "type": "range", "id": "cart_button_radius", "label": "Button Border Radius", "min": 0, "max": 30, "step": 5, "default": 25, "unit": "px" }
  ],
  "presets": [
    { "name": "Best Sellers Collection", "category": "Custom" }
  ],
  "templates": ["index", "collection", "page"]
}
{% endschema %}
