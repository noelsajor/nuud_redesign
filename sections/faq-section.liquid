<!-- FAQ Section (icon-only toggle; text + icon spaced; circle via padding) -->
<section class="faq-section {{ 'faq-root-' | append: section.id | replace: '_', '' | downcase }}"
         role="region"
         aria-labelledby="faq-title-{{ section.id | replace: '_', '' | downcase }}"
         style="
           {% if section.settings.section_background_image %}
             background-image: url('{{ section.settings.section_background_image | image_url: width: 2000 }}');
             background-size: cover;
             background-position: center;
             background-repeat: no-repeat;
           {% else %}
             background: {{ section.settings.section_background_color }};
           {% endif %}
           padding: 60px {{ settings.gutter_width }}px 60px {{ settings.gutter_width }}px;
           position: relative;
         ">

  {%- assign faq_uid = section.id | replace: '_', '' | downcase -%}

  {%- comment -%} Parse per-corner border radius CSV (tl,tr,br,bl) {%- endcomment -%}
  {%- assign br_vals = section.settings.question_border_radius_custom | split: ',' -%}
  {%- assign top_left     = br_vals[0] | default: '6' | strip -%}
  {%- assign top_right    = br_vals[1] | default: top_left  | strip -%}
  {%- assign bottom_right = br_vals[2] | default: top_left  | strip -%}
  {%- assign bottom_left  = br_vals[3] | default: top_right | strip -%}

  {% if section.settings.section_background_image and section.settings.overlay_opacity > 0 %}
    <div class="faq-section-overlay-{{ faq_uid }}"
         aria-hidden="true"
         style="position:absolute; inset:0; background-color: {{ section.settings.overlay_color }}; opacity: {{ section.settings.overlay_opacity | divided_by: 100.0 }}; pointer-events:none;">
    </div>
  {% endif %}

  <faq-section-{{ faq_uid }}
      class="faq-container-{{ faq_uid }}"
      style="
        max-width: {{ settings.container_width }}px;
        margin: 0 auto;
        padding-top: {{ section.settings.section_padding }}px;
        padding-bottom: {{ section.settings.section_padding }}px;
        {% if section.settings.container_background_image %}
          background-image: url('{{ section.settings.container_background_image | image_url: width: 1500 }}');
          background-size: cover; background-position: center; background-repeat: no-repeat;
        {% else %}
          background-color: {{ section.settings.background_color }};
        {% endif %}
        border-radius: {{ section.settings.border_radius }}px;
        position: relative; z-index: 2;
      ">

    <!-- Left Column (Intro) -->
    <div class="faq-content-{{ faq_uid }}">
      {% if section.settings.subheading != blank %}
        <p class="faq-subheading-{{ faq_uid }}"
           style="color: {{ section.settings.subheading_color }};">
          {{ section.settings.subheading }}
        </p>
      {% endif %}

      {% if section.settings.heading != blank %}
        <h2 id="faq-title-{{ faq_uid }}"
            class="faq-heading-{{ faq_uid }}"
            style="color: {{ section.settings.heading_color }};">
          {{ section.settings.heading }}
        </h2>
      {% else %}
        <h2 id="faq-title-{{ faq_uid }}" class="sr-only">Frequently Asked Questions</h2>
      {% endif %}

      {% if section.settings.body != blank %}
        <div class="faq-body-{{ faq_uid }}"
             style="color: {{ section.settings.body_color }};">
          {{ section.settings.body }}
        </div>
      {% endif %}
    </div>

    <!-- Right Column: Questions -->
    <ul class="faq-questions-{{ faq_uid }}" role="list">
      {% for i in (1..6) %}
        {% assign q_key = 'question_' | append: i %}
        {% assign a_key = 'answer_'   | append: i %}
        {% assign q = section.settings[q_key] %}
        {% assign a = section.settings[a_key] %}
        {% if q != blank and a != blank %}
          {%- assign q_text_id = 'faq-question-text-' | append: faq_uid | append: '-' | append: i -%}
          <li class="faq-item-{{ faq_uid }}"
              data-faq-item="{{ i }}"
              style="
                border: 1px solid {{ section.settings.question_border_color }};
                border-radius: {{ top_left }}px {{ top_right }}px {{ bottom_right }}px {{ bottom_left }}px;
                background-color: {{ section.settings.question_background }};
                background-clip: padding-box;
              ">

            <!-- Question row: text (static) + icon-only button (toggle) -->
            <div class="faq-question-row-{{ faq_uid }}">
              <span id="{{ q_text_id }}"
                    class="faq-question-text-{{ faq_uid }}"
                    style="
                      color: {{ section.settings.question_color }};
                      padding: {{ section.settings.question_padding }}px;
                    ">
                {{ q }}
              </span>

              <button class="faq-toggle-btn-{{ faq_uid }}"
                      type="button"
                      aria-expanded="false"
                      aria-controls="faq-answer-{{ faq_uid }}-{{ i }}"
                      aria-label="Toggle answer for {{ q | strip | escape }}">
                <svg class="faq-icon-{{ faq_uid }}"
                     viewBox="0 0 24 24"
                     fill="none" stroke="currentColor" stroke-width="2"
                     aria-hidden="true" focusable="false">
                  <polyline points="6,9 12,15 18,9"></polyline>
                </svg>
                <span class="sr-only">Toggle</span>
              </button>
            </div>

            <!-- Answer panel -->
            <div class="faq-answer-{{ faq_uid }}"
                 id="faq-answer-{{ faq_uid }}-{{ i }}"
                 role="region"
                 aria-labelledby="{{ q_text_id }}"
                 aria-hidden="true"
                 hidden
                 style="background-color: {{ section.settings.answer_background }};">
              <div class="faq-answer-content-{{ faq_uid }}"
                   style="
                     color: {{ section.settings.answer_color }};
                     padding: {{ section.settings.answer_padding }}px;
                   ">
                {{ a }}
              </div>
            </div>
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  </faq-section-{{ faq_uid }}>
</section>

<style>
/* =========================
   FAQ — Layout & Structure
   ========================= */
.faq-container-{{ faq_uid }}{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap: {{ section.settings.section_gap }}px;
  padding-left: {{ settings.gutter_width }}px;
  padding-right: {{ settings.gutter_width }}px;
}

.faq-content-{{ faq_uid }}{
  display:flex;
  flex-direction:column;
  gap:16px;
}

.faq-questions-{{ faq_uid }}{
  display:flex;
  flex-direction:column;
  gap: {{ section.settings.question_gap }}px;
  list-style:none;
  margin:0;
  padding:0;
}

/* Optional: if you truly want to force this font, keep it. */
.faq-question-text-{{ faq_uid }}{
  font-family:'Bricolage Grotesque' !important;
  font-weight:400;
  font-size:20px;
}

/* -------------------------
   Question row (single rule)
   ------------------------- */
.faq-question-row-{{ faq_uid }}{
  display:flex;
  align-items:center;              /* prevent stretch */
  justify-content:space-between;
  gap:12px;
  width:100%;
  padding:0 12px;                  /* no top/bottom padding => avoids fake ovals */
  cursor:default;
}

/* Let text set vertical rhythm */
.faq-question-text-{{ faq_uid }}{
  flex:1 1 auto;
  min-width:0;
  margin: 0;                    /* replaces row vertical padding */
}

.faq-item-{{ faq_uid }},
.faq-question-row-{{ faq_uid }},
.faq-toggle-btn-{{ faq_uid }}{
  font:inherit;
  letter-spacing:inherit;
}

/* =========================
   Toggle Button — PERFECT CIRCLE (bulletproof)
   ========================= */
.faq-toggle-btn-{{ faq_uid }}{
  --faq-btn-size: 44px;            /* 40–48px is good for tap targets */
  --faq-icon-size: 20px;
  margin: 0 !important;

  /* Do not let any parent layout stretch or scale it */
  flex:0 0 auto !important;
  align-self:center !important;

  /* Grid centers more rigidly than flex inside odd resets */
  display:inline-grid !important;
  place-items:center !important;

  /* Hard size in both axes + guards */
  inline-size: var(--faq-btn-size) !important;
  block-size: var(--faq-btn-size) !important;
  min-inline-size: var(--faq-btn-size) !important;
  min-block-size: var(--faq-btn-size) !important;
  max-inline-size: var(--faq-btn-size) !important;
  max-block-size: var(--faq-btn-size) !important;

  aspect-ratio: 1 / 1;             /* extra guard against ovals */

  /* Absolute resets so themes can’t sneak in */
  padding:0 !important;
  border:0 !important;
  border-radius:50% !important;
  box-sizing:border-box !important;
  background-clip: padding-box !important;

  color: {{ section.settings.icon_color }} !important;  /* default visible color */
  line-height:0 !important;         /* kill inline height artifacts */
  font-size:0 !important;           /* avoid text metrics affecting height */
  text-indent:0 !important;

  cursor:pointer;
  appearance:none !important;

  /* Neutralize any inherited transforms that squash circles */
  transform:none !important;
  transform-origin:center center !important;

  /* Prevent outside influence */
  isolation:isolate;
  contain: layout paint size;

  transition: background-color .2s ease, color .2s ease, box-shadow .25s ease;
  overflow:hidden;                   /* circular clip even if children overflow */
}

/* =========================
   Icon — Always visible and crisp
   ========================= */
.faq-toggle-btn-{{ faq_uid }} > .faq-icon-{{ faq_uid }}{
  width: var(--faq-icon-size) !important;
  height: var(--faq-icon-size) !important;
  max-width:none !important;
  max-height:none !important;
  flex:0 0 auto !important;
  display:block !important;
  pointer-events:none !important;

  /* Paint guards: if the theme sets svg/path fill/stroke, override it */
  stroke: currentColor !important;
  fill: none !important;
  stroke-width: 2px !important;
  vector-effect: non-scaling-stroke;  /* keep line thickness consistent */

  /* No surprise transforms from elsewhere */
  transform:none !important;
  transform-origin:center center !important;

  transition: transform .25s ease, color .2s ease;
}

/* Ensure inner shapes inherit stroke */
.faq-toggle-btn-{{ faq_uid }} .faq-icon-{{ faq_uid }} polyline,
.faq-toggle-btn-{{ faq_uid }} .faq-icon-{{ faq_uid }} line,
.faq-toggle-btn-{{ faq_uid }} .faq-icon-{{ faq_uid }} path{
  stroke: currentColor !important;
  fill: none !important;
  stroke-width: 2px !important;
  vector-effect: non-scaling-stroke;
}

/* =========================
   States
   ========================= */
.faq-toggle-btn-{{ faq_uid }}:hover{
  background-color:#1FC2DB !important;
  color: {{ section.settings.active_text_color }} !important; /* e.g., white */
}

.faq-item-{{ faq_uid }}.active .faq-toggle-btn-{{ faq_uid }}{
  background-color:#ff679a !important;
  color: {{ section.settings.active_text_color }} !important;
}

/* Only rotate the icon, never scale the button */
.faq-item-{{ faq_uid }}.active .faq-icon-{{ faq_uid }}{
  transform: rotate(180deg) !important;
}

.faq-icon-template- {
  margin: 0;
}

/* Accessible focus outline */
.faq-toggle-btn-{{ faq_uid }}:focus-visible{
  outline:2px solid currentColor !important;
  outline-offset:2px !important;
}

/* =========================
   Item Container & Answers
   ========================= */
.faq-item-{{ faq_uid }}{
  transition: background-color .2s ease, border-color .2s ease;
}

.faq-item-{{ faq_uid }}:hover,
.faq-item-{{ faq_uid }}.active{
  background-color: {{ section.settings.question_background }} !important;
  border-color: {{ section.settings.question_border_color }} !important;
}

/* Answer panel — height animation when enabled */
.faq-answer-{{ faq_uid }}{
  overflow:hidden;
  height:0; /* closed baseline */
}
{% if section.settings.enable_animation %}
.faq-answer-{{ faq_uid }}{ transition: height .25s ease; }
@media (prefers-reduced-motion: reduce){
  .faq-answer-{{ faq_uid }}, .faq-icon-{{ faq_uid }}{ transition:none !important; }
}
{% endif %}

/* =========================
   Typography (inherit theme)
   ========================= */
.faq-subheading-{{ faq_uid }}{ margin:0; }
.faq-heading-{{ faq_uid }}{
  margin:0;
  font-weight:600;
}
.faq-body-{{ faq_uid }} p{ margin:0 0 1em; }

/* =========================
   Responsive
   ========================= */
@media screen and (max-width: {{ settings.lap_container_width }}px){
  .faq-container-{{ faq_uid }}{ max-width: {{ settings.lap_container_width }}px; }
}
@media screen and (max-width: {{ settings.tab_container_width }}px){
  .faq-container-{{ faq_uid }}{
    max-width: {{ settings.tab_container_width }}px;
    padding-left: calc({{ settings.gutter_width }}px * .8);
    padding-right: calc({{ settings.gutter_width }}px * .8);
  }
}
@media (max-width: 768px){
  .faq-container-{{ faq_uid }}{
    grid-template-columns:1fr;
    gap: {{ section.settings.mobile_gap }}px;
    padding-top: calc({{ section.settings.section_padding }}px * .8);
    padding-bottom: calc({{ section.settings.section_padding }}px * .8);
    padding-left: calc({{ settings.gutter_width }}px * .6);
    padding-right: calc({{ settings.gutter_width }}px * .6);
  }
  .faq-content-{{ faq_uid }}{
    text-align: {{ section.settings.mobile_text_alignment }};
  }
}

/* =========================
   SR-only utility
   ========================= */
.sr-only{
  position:absolute;
  width:1px;
  height:1px;
  padding:0;
  margin:-1px;
  overflow:hidden;
  clip:rect(0,0,0,0);
  white-space:nowrap;
  border:0;
}
</style>



<script>
  (function() {
    const tagName = 'faq-section-{{ section.id | replace: "_", "" | downcase }}';
    const ANIM_ENABLED = {{ section.settings.enable_animation | json }};
    const RESPECTS_REDUCED = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    if (!customElements.get(tagName)) {
      class FaqSectionElement extends HTMLElement {
        connectedCallback(){ this._bind(); }

        _bind(){
          const rootId = '{{ section.id | replace: "_", "" | downcase }}';
          const items = this.querySelectorAll('.faq-item-' + rootId);
          const shouldAnimate = ANIM_ENABLED && !RESPECTS_REDUCED;

          items.forEach(item => {
            const btn   = item.querySelector('.faq-toggle-btn-' + rootId);
            const panel = item.querySelector('.faq-answer-' + rootId);
            if (!btn || !panel) return;

            // closed baseline
            panel.hidden = panel.getAttribute('aria-hidden') !== 'false';
            if (panel.hidden) panel.style.height = '0px';

            btn.addEventListener('click', () => {
              const isOpen = item.classList.contains('active');
              if (isOpen) {
                this._close(item, btn, panel, shouldAnimate);
              } else {
                this._open(item, btn, panel, shouldAnimate);
              }
            });
          });
        }

        _open(item, btn, panel, animate){
          item.classList.add('active');
          btn.setAttribute('aria-expanded','true');
          panel.removeAttribute('hidden');
          panel.setAttribute('aria-hidden','false');

          if (!animate) {
            panel.style.height = 'auto';
            return;
          }
          panel.style.height = '0px';
          panel.offsetHeight; // reflow
          panel.style.height = panel.scrollHeight + 'px';

          const onEnd = (e) => {
            if (e.propertyName !== 'height') return;
            panel.style.height = 'auto';
            panel.removeEventListener('transitionend', onEnd);
          };
          panel.addEventListener('transitionend', onEnd);
        }

        _close(item, btn, panel, animate){
          item.classList.remove('active');
          btn.setAttribute('aria-expanded','false');
          panel.setAttribute('aria-hidden','true');

          if (!animate) {
            panel.style.height = '0px';
            panel.setAttribute('hidden','');
            return;
          }
          panel.style.height = panel.scrollHeight + 'px';
          panel.offsetHeight; // reflow
          panel.style.height = '0px';

          const onEnd = (e) => {
            if (e.propertyName !== 'height') return;
            panel.setAttribute('hidden','');
            panel.removeEventListener('transitionend', onEnd);
          };
          panel.addEventListener('transitionend', onEnd);
        }
      }
      customElements.define(tagName, FaqSectionElement);
    }
  })();
</script>

{% schema %}
{
  "name": "FAQ section (A11y + SEO)",
  "settings": [
    { "type": "header", "content": "Content" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "FAQ" },
    { "type": "text", "id": "heading", "label": "Heading", "default": "Frequently Asked Questions" },
    { "type": "richtext", "id": "body", "label": "Body text", "default": "<p>Find answers to the most common questions about our products and services.</p>" },

    { "type": "header", "content": "Questions" },
    { "type": "text", "id": "question_1", "label": "Question 1", "default": "What is your return policy?" },
    { "type": "richtext", "id": "answer_1", "label": "Answer 1", "default": "<p>We offer a 30-day return policy for all unused items in their original packaging.</p>" },
    { "type": "text", "id": "question_2", "label": "Question 2", "default": "How long does shipping take?" },
    { "type": "richtext", "id": "answer_2", "label": "Answer 2", "default": "<p>Standard shipping takes 3-5 business days. Express shipping is available for 1-2 business days.</p>" },
    { "type": "text", "id": "question_3", "label": "Question 3", "default": "Do you offer international shipping?" },
    { "type": "richtext", "id": "answer_3", "label": "Answer 3", "default": "<p>Yes, we ship to most countries worldwide. Shipping costs and delivery times vary by location.</p>" },
    { "type": "text", "id": "question_4", "label": "Question 4" },
    { "type": "richtext", "id": "answer_4", "label": "Answer 4" },
    { "type": "text", "id": "question_5", "label": "Question 5" },
    { "type": "richtext", "id": "answer_5", "label": "Answer 5" },
    { "type": "text", "id": "question_6", "label": "Question 6" },
    { "type": "richtext", "id": "answer_6", "label": "Answer 6" },

    { "type": "header", "content": "Section background" },
    { "type": "image_picker", "id": "section_background_image", "label": "Background image" },
    { "type": "color", "id": "section_background_color", "label": "Background color", "default": "#f8f8f8" },
    { "type": "color", "id": "overlay_color", "label": "Overlay color", "default": "#000000" },
    { "type": "range", "id": "overlay_opacity", "label": "Overlay opacity", "min": 0, "max": 80, "step": 5, "unit": "%", "default": 0 },

    { "type": "header", "content": "Container background" },
    { "type": "image_picker", "id": "container_background_image", "label": "Container background image" },
    { "type": "color", "id": "background_color", "label": "Container background color", "default": "#ffffff" },

    { "type": "header", "content": "Layout" },
    { "type": "range", "id": "section_padding", "label": "Section padding", "min": 20, "max": 80, "step": 5, "unit": "px", "default": 40 },
    { "type": "range", "id": "section_gap", "label": "Gap between content and questions", "min": 20, "max": 80, "step": 5, "unit": "px", "default": 40 },
    { "type": "range", "id": "mobile_gap", "label": "Mobile gap", "min": 15, "max": 50, "step": 5, "unit": "px", "default": 30 },
    {
      "type": "select",
      "id": "mobile_text_alignment",
      "label": "Mobile text alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    { "type": "range", "id": "question_gap", "label": "Gap between questions", "min": 5, "max": 30, "step": 1, "unit": "px", "default": 12 },
    { "type": "range", "id": "question_padding", "label": "Question padding", "min": 10, "max": 30, "step": 2, "unit": "px", "default": 20 },
    { "type": "range", "id": "answer_padding", "label": "Answer padding", "min": 10, "max": 30, "step": 2, "unit": "px", "default": 20 },
    { "type": "range", "id": "border_radius", "label": "Section border radius", "min": 0, "max": 30, "step": 2, "unit": "px", "default": 8 },

    {
      "type": "text",
      "id": "question_border_radius_custom",
      "label": "Question border radius (tl,tr,br,bl)",
      "default": "6,6,6,6",
      "info": "Enter values separated by commas: top-left, top-right, bottom-right, bottom-left (e.g., 16,8,16,8)"
    },

    { "type": "header", "content": "Colors" },
    { "type": "color", "id": "subheading_color", "label": "Subheading color", "default": "#777777" },
    { "type": "color", "id": "heading_color", "label": "Heading color", "default": "#111111" },
    { "type": "color", "id": "body_color", "label": "Body text color", "default": "#333333" },
    { "type": "color", "id": "question_color", "label": "Question text color", "default": "#000000" },
    { "type": "color", "id": "answer_color", "label": "Answer text color", "default": "#333333" },
    { "type": "color", "id": "question_background", "label": "Question background", "default": "#ffffff" },
    { "type": "color", "id": "answer_background", "label": "Answer background", "default": "#fafafa" },
    { "type": "color", "id": "question_border_color", "label": "Question border color", "default": "#dddddd" },
    { "type": "color", "id": "icon_color", "label": "Icon color", "default": "#333333" },

    { "type": "header", "content": "Animation" },
    {
      "type": "checkbox",
      "id": "enable_animation",
      "label": "Enable animation",
      "default": true,
      "info": "Smoothly expands/collapses answers. Automatically disabled for users who prefer reduced motion."
    },

    { "type": "header", "content": "States" },
    {
      "type": "checkbox",
      "id": "enable_hover_color",
      "label": "Enable hover color on questions",
      "default": true
    },
    {
      "type": "color",
      "id": "active_background_color",
      "label": "Active/Hover background color (container, unused in this variant)",
      "default": "#111111"
    },
    {
      "type": "color",
      "id": "active_text_color",
      "label": "Active & Hover text/icon color",
      "default": "#ffffff"
    }
  ],
  "presets": [
    { "name": "FAQ Section", "category": "Custom" }
  ]
}
{% endschema %}
