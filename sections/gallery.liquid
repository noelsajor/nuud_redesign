{% assign margin = section.settings.margin | split: ',' %}
{% assign margin_top = margin[0] %}
{% assign margin_bottom = margin[1] %}
{% assign padding = section.settings.padding | split: ',' %}
{% assign padding_top = padding[0] %}
{% assign padding_bottom = padding[1] %}

<div
  id="gallery-{{ section.id }}"
  data-section-id="{{ section.id }}"
  data-section-type="gallery_page"
  class="gallery_page align-{{ section.settings.content_alignment }}"
  style="
    background: {{ section.settings.section_bg_color | default: 'transparent' }};
    margin-top: {{ margin_top | default: 0 }}px;
    margin-bottom: {{ margin_bottom | default: 0 }}px;
  "
>
  <div class="{% render 'container-settings' %}" style="padding-top: {{ padding_top | default: 0 }}px; padding-bottom: {{ padding_bottom | default: 0 }}px;">
    <div class="row {{ section.settings.custom_class_name }}">
      
      {%- comment -%} Local heading/subheading/body (replaces theme snippet) {%- endcomment -%}
      {% if section.settings.heading != blank or section.settings.subheading != blank or section.settings.body_text != blank %}
        <header class="gallery-heading">
          {% if section.settings.subheading != blank %}
            <div class="gallery-subheading">{{ section.settings.subheading }}</div>
          {% endif %}
          {% if section.settings.heading != blank %}
            <h2 class="gallery-title">{{ section.settings.heading }}</h2>
          {% endif %}
          {% if section.settings.body_text != blank %}
            <div class="gallery-body rte">
              {{ section.settings.body_text }}
            </div>
          {% endif %}
        </header>
      {% endif %}

      <!-- Gallery grid wrapper -->
      <div class="dt-sc-column four-column gallery-grid">
        {% for block in section.blocks %}
          <div class="bg-effect-{{ block.id }} gallery" style="position:relative;">
            {% unless section.settings.use_overlay_icons %}
              <a href="{% if block.settings.image != blank %}{{ block.settings.image | img_url: 'master' }}{% endif %}">
            {% endunless %}

            {% if block.settings.image != blank %}
              <img
                class="lazyload"
                data-src="{{ block.settings.image | img_url: 'master' }}"
                data-widths="[180, 360, 470, 600, 770, 970, 1060, 1280, 1512, 1728, 2048]"
                data-aspectratio="{{ block.settings.image.aspect_ratio }}"
                data-sizes="auto"
                alt="{{ block.settings.title | escape }}"
              >
              <noscript>
                {{ block.settings.image | img_url: '480x480', scale: 2 | img_tag: block.settings.image.alt, 'dt-sc-noscript-image' }}
              </noscript>
            {% else %}
              {{ 'image' | placeholder_svg_tag }}
            {% endif %}

            <div class="ovrly17">
              {% if section.settings.use_overlay %}
                <div class="image-overlay">
              {% endif %}

              {% if section.settings.use_overlay_icons %}
                <div class="links">
                  <a href="{{ block.settings.image | img_url: 'master' }}" class="gallery-pop">
                    <i class="fa fa-search" aria-hidden="true"></i>
                    <span class="visually-hidden">Open image</span>
                  </a>
                </div>
              {% endif %}

              {% if block.settings.gallery_title != blank or block.settings.category != blank %}
                <div class="image-overlay-details">
                  {% if block.settings.gallery_title != blank %}
                    <h4><a href="{{ block.settings.gallery_link }}">{{ block.settings.gallery_title }}</a></h4>
                  {% endif %}
                  {% if block.settings.category != blank %}
                    <p>{{ block.settings.category }}</p>
                  {% endif %}
                </div>
              {% endif %}

              {% if section.settings.use_overlay %}
                </div>
              {% endif %}
            </div>

            {% unless section.settings.use_overlay_icons %}
              </a>
            {% endunless %}
          </div>
        {% endfor %}
      </div>
      <!-- /Gallery grid wrapper -->

    </div>
  </div>
</div>

<style>
  /* ------- FLEX GRID so alignment works ------- */
  #gallery-{{ section.id }} .gallery-grid{
    display: flex !important;
    flex-wrap: wrap;
    gap: 30px;
    --cols-desktop: 4;
    --cols-laptop: 3;
    --cols-tablet: 2;
    --cols-mobile: 1;           /* NEW: phone layout */
    --col-gap: 30px;
    width: 100%;
  }

  /* Row alignment via section setting */
  #gallery-{{ section.id }}.align-left  .gallery-grid{ justify-content: flex-start; }
  #gallery-{{ section.id }}.align-center .gallery-grid{ justify-content: center; }
  #gallery-{{ section.id }}.align-right .gallery-grid{ justify-content: flex-end; }

  /* Card width by breakpoint */
  #gallery-{{ section.id }} .gallery{
    flex: 0 1 calc((100% - (var(--cols-desktop) - 1) * var(--col-gap)) / var(--cols-desktop));
    max-width: calc((100% - (var(--cols-desktop) - 1) * var(--col-gap)) / var(--cols-desktop));
    box-sizing: border-box;     /* safer sizing */
    min-width: 0;               /* prevent flex overflow on iOS */
  }
  @media (max-width: 1199px){
    #gallery-{{ section.id }} .gallery{
      flex-basis: calc((100% - (var(--cols-laptop) - 1) * var(--col-gap)) / var(--cols-laptop));
      max-width:  calc((100% - (var(--cols-laptop) - 1) * var(--col-gap)) / var(--cols-laptop));
    }
  }
  @media (max-width: 767px){
    #gallery-{{ section.id }} .gallery{
      flex-basis: calc((100% - (var(--cols-tablet) - 1) * var(--col-gap)) / var(--cols-tablet));
      max-width:  calc((100% - (var(--cols-tablet) - 1) * var(--col-gap)) / var(--cols-tablet));
    }
  }
  /* NEW: small phones → single column + tighter gap */
  @media (max-width: 480px){
    #gallery-{{ section.id }} .gallery-grid{ gap: 16px; }
    #gallery-{{ section.id }} .gallery{
      flex-basis: calc((100% - (var(--cols-mobile) - 1) * 16px) / var(--cols-mobile));
      max-width:  calc((100% - (var(--cols-mobile) - 1) * 16px) / var(--cols-mobile));
    }
  }

  /* ---------- Heading block ---------- */
  #gallery-{{ section.id }} .gallery-heading{
    margin-bottom: 28px;
  }
  /* alignment */
  #gallery-{{ section.id }}.align-left  .gallery-heading{ text-align: left; }
  #gallery-{{ section.id }}.align-center .gallery-heading{ text-align: center; }
  #gallery-{{ section.id }}.align-right .gallery-heading{ text-align: right; }

  /* colors & type from settings */
  #gallery-{{ section.id }} .gallery-title{
    margin: 0 0 6px;
    color: {{ section.settings.section_heading_color | default: '#111111' }};
  }
  #gallery-{{ section.id }} .gallery-subheading{
    margin-bottom: 6px;
    color: {{ section.settings.section_sub_heading_color | default: '#666666' }};
    font-size: .95em;
    letter-spacing: .03em;
    text-transform: uppercase;
  }
  #gallery-{{ section.id }} .gallery-body{
    color: {{ section.settings.section_description_color | default: '#444444' }};
    max-width: 65ch;
    {% if section.settings.content_alignment == 'center' %}
      margin-left: auto; margin-right: auto;
    {% elsif section.settings.content_alignment == 'right' %}
      margin-left: auto;
    {% endif %}
  }

  /* ---------- Images & overlays ---------- */
  #gallery-{{ section.id }} .gallery img{
    width: 100%;
    height: auto;               /* was 100% – prevents distortion on mobile */
    display: block;
    object-fit: cover;
    object-position: center center;
  }
  #gallery-{{ section.id }}.align-left  .gallery img  { object-position: left  center; }
  #gallery-{{ section.id }}.align-center .gallery img { object-position: center center; }
  #gallery-{{ section.id }}.align-right .gallery img  { object-position: right center; }

  #gallery-{{ section.id }} .image-overlay .links i{ font-weight:800; }
  #gallery-{{ section.id }} .gallery:hover .image-overlay { opacity: 1; }

  {% if section.settings.use_overlay %}
    #gallery-{{ section.id }} .gallery .image-overlay{
      background: {{ section.settings.img_overlay | color_modify: 'alpha', 0.7 }};
    }
  {% endif %}

  #gallery-{{ section.id }} .image-overlay .links{
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    text-align: center; margin: 0;
  }
  #gallery-{{ section.id }} .gallery .links a{
    background: {{ section.settings.img_overlay_icon_bg1 }};
    color: {{ section.settings.img_overlay_icon_txt }};
    padding: 20px; clip-path: circle(); opacity: 0; transition: opacity .25s ease;
  }
  #gallery-{{ section.id }} .gallery:hover .links a{ opacity: 1; }
  #gallery-{{ section.id }} .gallery .links a:hover{
    background: {{ section.settings.img_overlay_icon_bg }};
    color: {{ section.settings.img_overlay_icon_hover_txt }};
  }
  #gallery-{{ section.id }} .gallery .image-overlay-details h4 a { color: {{ section.settings.img_overlay_title }}; }
  #gallery-{{ section.id }} .gallery .image-overlay-details p     { color: {{ section.settings.img_overlay_catgry }}; }
</style>

<script>
  (function(){
    if (window.jQuery && jQuery.fn && jQuery.fn.magnificPopup) {
      jQuery('.gallery-pop').magnificPopup({
        type: 'image',
        closeOnContentClick: true,
        mainClass: 'mfp-img-mobile',
        image: { verticalFit: true }
      });
    }
  }());
</script>

{% schema %}
{
  "name": "Gallery",
  "max_blocks": 100,
  "settings": [
    { "type": "checkbox", "id": "full", "label": "Show Full width" },
    { "type": "checkbox", "id": "spacing_both_ends", "label": "Enable Right & Left Spacing (Works only on Fullwidth)", "default": false },

    { "type": "text", "id": "padding", "label": "Style value (Padding)", "default":"0,0", "info":"Top(px),Bottom(px)" },
    { "type": "text", "id": "margin", "label": "Style value (Margin)", "default":"0,0", "info":"Top(px),Bottom(px)" },
    { "type": "text", "id": "custom_class_name", "label": "Custom class name" },

    { "type": "color", "id": "section_bg_color", "label": "Section background color", "default": "#ffffff" },
    { "type": "select", "id": "content_alignment", "label": "Content alignment", "default": "center",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ]
    },

    { "type": "header", "content": "Heading content" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "Our gallery" },
    { "type": "text", "id": "heading", "label": "Heading", "default": "Explore the looks" },
    { "type": "richtext", "id": "body_text", "label": "Body text", "default": "<p>Add a short description for this gallery section.</p>" },

    { "type": "header", "content": "Heading colors" },
    { "type": "color", "id": "section_heading_color", "label": "Heading color", "default": "#111111" },
    { "type": "color", "id": "section_sub_heading_color", "label": "Subheading color", "default": "#666666" },
    { "type": "color", "id": "section_description_color", "label": "Body text color", "default": "#444444" },

    { "type": "header", "content": "Overlay" },
    { "type": "checkbox", "id": "use_overlay", "label": "Use Overlay" },
    { "type": "color", "id": "img_overlay", "label": "Image Overlay", "default": "#000000" },
    { "type": "color", "id": "img_overlay_title", "label": "Overlay Title", "default": "#ffffff" },
    { "type": "color", "id": "img_overlay_catgry", "label": "Overlay Category", "default": "#ffffff" },

    { "type": "checkbox", "id": "use_overlay_icons", "label": "Use Overlay Icons" },
    { "type": "color", "id": "img_overlay_icon_bg1", "label": "Overlay Icon bg (idle)", "default": "#ffffff" },
    { "type": "color", "id": "img_overlay_icon_txt", "label": "Overlay Icon text", "default": "#111111" },
    { "type": "color", "id": "img_overlay_icon_bg", "label": "Overlay Icon hover bg", "default": "#111111" },
    { "type": "color", "id": "img_overlay_icon_hover_txt", "label": "Overlay Icon hover text", "default": "#ffffff" }
  ],
  "blocks": [
    {
      "type": "Image",
      "name": "Gallery",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Image", "info": "Size: 650x760" },
        { "type": "text", "id": "title", "label": "Alt Text", "default": "Collection Name" },
        { "type": "text", "id": "gallery_title", "label": "Title" },
        { "type": "text", "id": "category", "label": "Category" },
        { "type": "url", "id": "gallery_link", "label": "Link" }
      ]
    }
  ],
  "presets": [{ "name": "Gallery" }]
}
{% endschema %}
