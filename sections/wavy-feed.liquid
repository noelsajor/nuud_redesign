<!-- Feed Gallery with Overlapping Waves (animated, seamless loop + bob) + Instagram Carousel -->
<section class="features-wave-section"
         role="region"
         aria-labelledby="feed-title"
         style="background: {% if section.settings.use_gradient %}{{ section.settings.background_gradient }}{% else %}{{ section.settings.background_color }}{% endif %};
                padding: 0;">

  {%- comment -%} ---------- TOP WAVE (animated, full-bleed) ---------- {%- endcomment -%}
  {% if section.settings.show_top_wave %}
  <div class="wave-top"
       style="top: -{{ section.settings.wave_overlap_top }}px; height: {{ section.settings.wave_overlap_top }}px;"
       aria-hidden="true">
    <div class="wave-bob wave-bob--top {% if section.settings.enable_wave_animation %}is-bobbing{% endif %}"
         style="--wave-bob: {{ section.settings.wave_bob_amount }}px; --wave-bob-speed: {{ section.settings.wave_bob_speed }}s;">
      <div class="wave-track wave-track--top {% if section.settings.enable_wave_animation %}is-animating{% endif %} {% if section.settings.wave_direction == 'right' %}dir-right{% endif %}"
           style="--wave-speed: {{ section.settings.wave_scroll_speed }}s;">
        <!-- strip A -->
        <div class="wave-strip">
          <svg viewBox="0 0 1440 100" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" role="presentation" focusable="false">
            {% assign freq = section.settings.wave_frequency %}
            {% assign amp = section.settings.wave_amplitude %}
            {% if freq == 1 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 10 }} Q720,{{ 100 | minus: amp | minus: amp | plus: 10 }} 1440,{{ 100 | minus: amp | plus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,100 L0,{{ 100 | minus: amp }} Q720,{{ 100 | minus: amp | minus: amp }} 1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,100 L0,{{ 100 | minus: amp | minus: 10 }} Q720,{{ 100 | minus: amp | minus: amp | minus: 20 }} 1440,{{ 100 | minus: amp | minus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,100 L0,{{ 100 | minus: amp }} L720,{{ 100 | minus: amp | minus: amp }} L1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 5 }} C480,{{ 100 | minus: amp | minus: amp | plus: 5 }} 960,{{ 100 | minus: amp | minus: amp | plus: 5 }} 1440,{{ 100 | minus: amp | plus: 5 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% elsif freq == 2 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 10 }} Q360,{{ 100 | minus: amp | minus: amp | plus: 10 }} 720,{{ 100 | minus: amp | plus: 10 }} T1440,{{ 100 | minus: amp | plus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,100 L0,{{ 100 | minus: amp }} Q360,{{ 100 | minus: amp | minus: amp }} 720,{{ 100 | minus: amp }} T1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,100 L0,{{ 100 | minus: amp | minus: 10 }} Q360,{{ 100 | minus: amp | minus: amp | minus: 20 }} 720,{{ 100 | minus: amp | minus: 10 }} T1440,{{ 100 | minus: amp | minus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,100 L0,{{ 100 | minus: amp }} L360,{{ 100 | minus: amp | minus: amp }} L720,{{ 100 | minus: amp }} L1080,{{ 100 | minus: amp | minus: amp }} L1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 5 }} C240,{{ 100 | minus: amp | minus: amp | plus: 5 }} 480,{{ 100 | minus: amp | minus: amp | plus: 5 }} 720,{{ 100 | minus: amp | plus: 5 }} C960,{{ 100 | minus: amp | plus: amp | plus: 5 }} 1200,{{ 100 | minus: amp | plus: amp | plus: 5 }} 1440,{{ 100 | minus: amp | plus: 5 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% elsif freq == 3 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 10 }} Q240,{{ 100 | minus: amp | minus: amp | plus: 10 }} 480,{{ 100 | minus: amp | plus: 10 }} T960,{{ 100 | minus: amp | plus: 10 }} T1440,{{ 100 | minus: amp | plus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,100 L0,{{ 100 | minus: amp }} Q240,{{ 100 | minus: amp | minus: amp }} 480,{{ 100 | minus: amp }} T960,{{ 100 | minus: amp }} T1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,100 L0,{{ 100 | minus: amp | minus: 10 }} Q240,{{ 100 | minus: amp | minus: amp | minus: 20 }} 480,{{ 100 | minus: amp | minus: 10 }} T960,{{ 100 | minus: amp | minus: 10 }} T1440,{{ 100 | minus: amp | minus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,100 L0,{{ 100 | minus: amp }} L240,{{ 100 | minus: amp | minus: amp }} L480,{{ 100 | minus: amp }} L720,{{ 100 | minus: amp | minus: amp }} L960,{{ 100 | minus: amp }} L1200,{{ 100 | minus: amp | minus: amp }} L1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 5 }} C160,{{ 100 | minus: amp | minus: amp | plus: 5 }} 320,{{ 100 | minus: amp | minus: amp | plus: 5 }} 480,{{ 100 | minus: amp | plus: 5 }} C640,{{ 100 | minus: amp | plus: amp | plus: 5 }} 800,{{ 100 | minus: amp | plus: amp | plus: 5 }} 960,{{ 100 | minus: amp | plus: 5 }} C1120,{{ 100 | minus: amp | minus: amp | plus: 5 }} 1280,{{ 100 | minus: amp | minus: amp | plus: 5 }} 1440,{{ 100 | minus: amp | plus: 5 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% elsif freq == 4 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 10 }} Q180,{{ 100 | minus: amp | minus: amp | plus: 10 }} 360,{{ 100 | minus: amp | plus: 10 }} T720,{{ 100 | minus: amp | plus: 10 }} T1080,{{ 100 | minus: amp | plus: 10 }} T1440,{{ 100 | minus: amp | plus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,100 L0,{{ 100 | minus: amp }} Q180,{{ 100 | minus: amp | minus: amp }} 360,{{ 100 | minus: amp }} T720,{{ 100 | minus: amp }} T1080,{{ 100 | minus: amp }} T1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,100 L0,{{ 100 | minus: amp | minus: 10 }} Q180,{{ 100 | minus: amp | minus: amp | minus: 20 }} 360,{{ 100 | minus: amp | minus: 10 }} T720,{{ 100 | minus: amp | minus: 10 }} T1080,{{ 100 | minus: amp | minus: 10 }} T1440,{{ 100 | minus: amp | minus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,100 L0,{{ 100 | minus: amp }} L180,{{ 100 | minus: amp | minus: amp }} L360,{{ 100 | minus: amp }} L540,{{ 100 | minus: amp | minus: amp }} L720,{{ 100 | minus: amp }} L900,{{ 100 | minus: amp | minus: amp }} L1080,{{ 100 | minus: amp }} L1260,{{ 100 | minus: amp | minus: amp }} L1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 5 }} C120,{{ 100 | minus: amp | minus: amp | plus: 5 }} 240,{{ 100 | minus: amp | minus: amp | plus: 5 }} 360,{{ 100 | minus: amp | plus: 5 }} C480,{{ 100 | minus: amp | plus: amp | plus: 5 }} 600,{{ 100 | minus: amp | plus: amp | plus: 5 }} 720,{{ 100 | minus: amp | plus: 5 }} C840,{{ 100 | minus: amp | minus: amp | plus: 5 }} 960,{{ 100 | minus: amp | minus: amp | plus: 5 }} 1080,{{ 100 | minus: amp | plus: 5 }} C1200,{{ 100 | minus: amp | plus: amp | plus: 5 }} 1320,{{ 100 | minus: amp | plus: amp | plus: 5 }} 1440,{{ 100 | minus: amp | plus: 5 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% else %}
              <path d="M0,100 L0,50 Q360,30 720,50 T1440,50 L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
            {% endif %}
          </svg>
        </div>
        <!-- strip B (clone for seamless loop) -->
        <div class="wave-strip" aria-hidden="true">
          <svg viewBox="0 0 1440 100" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" role="presentation" focusable="false">
            {% assign freq = section.settings.wave_frequency %}
            {% assign amp = section.settings.wave_amplitude %}
            {% if freq == 1 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 10 }} Q720,{{ 100 | minus: amp | minus: amp | plus: 10 }} 1440,{{ 100 | minus: amp | plus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,100 L0,{{ 100 | minus: amp }} Q720,{{ 100 | minus: amp | minus: amp }} 1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,100 L0,{{ 100 | minus: amp | minus: 10 }} Q720,{{ 100 | minus: amp | minus: amp | minus: 20 }} 1440,{{ 100 | minus: amp | minus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,100 L0,{{ 100 | minus: amp }} L720,{{ 100 | minus: amp | minus: amp }} L1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 5 }} C480,{{ 100 | minus: amp | minus: amp | plus: 5 }} 960,{{ 100 | minus: amp | minus: amp | plus: 5 }} 1440,{{ 100 | minus: amp | plus: 5 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% elsif freq == 2 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 10 }} Q360,{{ 100 | minus: amp | minus: amp | plus: 10 }} 720,{{ 100 | minus: amp | plus: 10 }} T1440,{{ 100 | minus: amp | plus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,100 L0,{{ 100 | minus: amp }} Q360,{{ 100 | minus: amp | minus: amp }} 720,{{ 100 | minus: amp }} T1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,100 L0,{{ 100 | minus: amp | minus: 10 }} Q360,{{ 100 | minus: amp | minus: amp | minus: 20 }} 720,{{ 100 | minus: amp | minus: 10 }} T1440,{{ 100 | minus: amp | minus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,100 L0,{{ 100 | minus: amp }} L360,{{ 100 | minus: amp | minus: amp }} L720,{{ 100 | minus: amp }} L1080,{{ 100 | minus: amp | minus: amp }} L1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 5 }} C240,{{ 100 | minus: amp | minus: amp | plus: 5 }} 480,{{ 100 | minus: amp | minus: amp | plus: 5 }} 720,{{ 100 | minus: amp | plus: 5 }} C960,{{ 100 | minus: amp | plus: amp | plus: 5 }} 1200,{{ 100 | minus: amp | plus: amp | plus: 5 }} 1440,{{ 100 | minus: amp | plus: 5 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% elsif freq == 3 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 10 }} Q240,{{ 100 | minus: amp | minus: amp | plus: 10 }} 480,{{ 100 | minus: amp | plus: 10 }} T960,{{ 100 | minus: amp | plus: 10 }} T1440,{{ 100 | minus: amp | plus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,100 L0,{{ 100 | minus: amp }} Q240,{{ 100 | minus: amp | minus: amp }} 480,{{ 100 | minus: amp }} T960,{{ 100 | minus: amp }} T1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,100 L0,{{ 100 | minus: amp | minus: 10 }} Q240,{{ 100 | minus: amp | minus: amp | minus: 20 }} 480,{{ 100 | minus: amp | minus: 10 }} T960,{{ 100 | minus: amp | minus: 10 }} T1440,{{ 100 | minus: amp | minus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,100 L0,{{ 100 | minus: amp }} L240,{{ 100 | minus: amp | minus: amp }} L480,{{ 100 | minus: amp }} L720,{{ 100 | minus: amp | minus: amp }} L960,{{ 100 | minus: amp }} L1200,{{ 100 | minus: amp | minus: amp }} L1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 5 }} C160,{{ 100 | minus: amp | minus: amp | plus: 5 }} 320,{{ 100 | minus: amp | minus: amp | plus: 5 }} 480,{{ 100 | minus: amp | plus: 5 }} C640,{{ 100 | minus: amp | plus: amp | plus: 5 }} 800,{{ 100 | minus: amp | plus: amp | plus: 5 }} 960,{{ 100 | minus: amp | plus: 5 }} C1120,{{ 100 | minus: amp | minus: amp | plus: 5 }} 1280,{{ 100 | minus: amp | minus: amp | plus: 5 }} 1440,{{ 100 | minus: amp | plus: 5 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% elsif freq == 4 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 10 }} Q180,{{ 100 | minus: amp | minus: amp | plus: 10 }} 360,{{ 100 | minus: amp | plus: 10 }} T720,{{ 100 | minus: amp | plus: 10 }} T1080,{{ 100 | minus: amp | plus: 10 }} T1440,{{ 100 | minus: amp | plus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,100 L0,{{ 100 | minus: amp }} Q180,{{ 100 | minus: amp | minus: amp }} 360,{{ 100 | minus: amp }} T720,{{ 100 | minus: amp }} T1080,{{ 100 | minus: amp }} T1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,100 L0,{{ 100 | minus: amp | minus: 10 }} Q180,{{ 100 | minus: amp | minus: amp | minus: 20 }} 360,{{ 100 | minus: amp | minus: 10 }} T720,{{ 100 | minus: amp | minus: 10 }} T1080,{{ 100 | minus: amp | minus: 10 }} T1440,{{ 100 | minus: amp | minus: 10 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,100 L0,{{ 100 | minus: amp }} L180,{{ 100 | minus: amp | minus: amp }} L360,{{ 100 | minus: amp }} L540,{{ 100 | minus: amp | minus: amp }} L720,{{ 100 | minus: amp }} L900,{{ 100 | minus: amp | minus: amp }} L1080,{{ 100 | minus: amp }} L1260,{{ 100 | minus: amp | minus: amp }} L1440,{{ 100 | minus: amp }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,100 L0,{{ 100 | minus: amp | plus: 5 }} C120,{{ 100 | minus: amp | minus: amp | plus: 5 }} 240,{{ 100 | minus: amp | minus: amp | plus: 5 }} 360,{{ 100 | minus: amp | plus: 5 }} C480,{{ 100 | minus: amp | plus: amp | plus: 5 }} 600,{{ 100 | minus: amp | plus: amp | plus: 5 }} 720,{{ 100 | minus: amp | plus: 5 }} C840,{{ 100 | minus: amp | minus: amp | plus: 5 }} 960,{{ 100 | minus: amp | minus: amp | plus: 5 }} 1080,{{ 100 | minus: amp | plus: 5 }} C1200,{{ 100 | minus: amp | plus: amp | plus: 5 }} 1320,{{ 100 | minus: amp | plus: amp | plus: 5 }} 1440,{{ 100 | minus: amp | plus: 5 }} L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% else %}
              <path d="M0,100 L0,50 Q360,30 720,50 T1440,50 L1440,100 Z" fill="{{ section.settings.wave_color }}"/>
            {% endif %}
          </svg>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {%- comment -%} ---------- INNER CONTAINER (fixed 1280px, padded 80/40) ---------- {%- endcomment -%}
  <div class="max-container" style="position:relative; z-index:3;">
    {%- comment -%} ---------- CONTENT (INSTAGRAM CAROUSEL) ---------- {%- endcomment -%}
    <div class="features-container">
      {% if section.settings.section_title != blank %}
        <h3 id="feed-title"
            style="color: {{ section.settings.title_color }}; text-align: {{ section.settings.title_alignment }}; margin: 0 0 24px 0; line-height: 1.2;">
          {{ section.settings.section_title }}
        </h3>
      {% endif %}

      <div class="insta-carousel"
           data-visible="{{ section.settings.carousel_desktop }}"
           data-tablet="{{ section.settings.carousel_tablet }}"
           data-mobile="{{ section.settings.carousel_mobile }}"
           data-autoplay="{{ section.settings.autoplay | json }}"
           data-autoplay-interval="{{ section.settings.autoplay_interval }}"
           role="listbox" aria-label="Instagram posts carousel">

        <button class="insta-nav insta-nav--prev" aria-label="Previous posts" type="button" disabled>&larr;</button>

        <div class="insta-track" id="instaTrack-{{ section.id }}" tabindex="0" aria-live="polite">
          <!-- Placeholder carousel shown until IG feed loads -->
          <div class="insta-skeletons">
            {% assign ph_count = 5 %}
            {% for i in (1..ph_count) %}
              <div class="insta-slide placeholder" role="option" aria-label="Placeholder post {{ i }}">
                <a href="#" tabindex="-1" aria-hidden="true">
                  <div class="insta-imgwrap">
                    <img
                      class="insta-img"
                      alt="Placeholder post {{ i }}"
                      loading="eager"
                      decoding="async"
                      src="data:image/svg+xml;utf8,
                        <svg xmlns='http://www.w3.org/2000/svg' width='1200' height='1200' viewBox='0 0 1200 1200'>
                          <defs>
                            <linearGradient id='g' x1='0' x2='1' y1='0' y2='1'>
                              <stop offset='0%' stop-color='%23f2f2f2'/>
                              <stop offset='100%' stop-color='%23e6e6e6'/>
                            </linearGradient>
                          </defs>
                          <rect width='1200' height='1200' fill='url(%23g)'/>
                          <circle cx='600' cy='600' r='220' fill='%23ffffff' opacity='0.65'/>
                          <rect x='390' y='540' width='420' height='320' rx='24' ry='24' fill='%23ffffff' opacity='0.85'/>
                          <circle cx='600' cy='460' r='90' fill='%23ffffff' opacity='0.85'/>
                        </svg>" />
                  </div>
                </a>
              </div>
            {% endfor %}
          </div>
        </div>

        <button class="insta-nav insta-nav--next" aria-label="Next posts" type="button">&rarr;</button>
      </div>

      {% if section.settings.show_view_on_ig and section.settings.instagram_profile_url != blank %}
        <p class="insta-cta" style="text-align: {{ section.settings.title_alignment }}; margin-top: 16px;">
          <a href="{{ section.settings.instagram_profile_url }}" target="_blank" rel="noopener nofollow">View on Instagram</a>
        </p>
      {% endif %}
    </div>
  </div>

  {%- comment -%} ---------- BOTTOM WAVE (animated, full-bleed) ---------- {%- endcomment -%}
  {% if section.settings.show_bottom_wave %}
  <div class="wave-bottom"
       style="bottom: -{{ section.settings.wave_overlap_bottom }}px; height: {{ section.settings.wave_overlap_bottom }}px;"
       aria-hidden="true">
    <div class="wave-bob wave-bob--bottom {% if section.settings.enable_wave_animation %}is-bobbing{% endif %}"
         style="--wave-bob: {{ section.settings.wave_bob_amount }}px; --wave-bob-speed: {{ section.settings.wave_bob_speed }}s;">
      <div class="wave-track wave-track--bottom {% if section.settings.enable_wave_animation %}is-animating{% endif %} {% if section.settings.wave_direction == 'right' %}dir-right{% endif %}"
           style="--wave-speed: {{ section.settings.wave_scroll_speed | times: 1.15 }}s;">
        <!-- strip A -->
        <div class="wave-strip">
          <svg viewBox="0 0 1440 100" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" role="presentation" focusable="false">
            {% assign freq = section.settings.wave_frequency %}
            {% assign amp = section.settings.wave_amplitude %}
            {% if freq == 1 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,0 L0,{{ amp | minus: 10 }} Q720,{{ amp | plus: amp | minus: 10 }} 1440,{{ amp | minus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,0 L0,{{ amp }} Q720,{{ amp | plus: amp }} 1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,0 L0,{{ amp | plus: 10 }} Q720,{{ amp | plus: amp | plus: 20 }} 1440,{{ amp | plus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,0 L0,{{ amp }} L720,{{ amp | plus: amp }} L1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,0 L0,{{ amp | minus: 5 }} C480,{{ amp | plus: amp | minus: 5 }} 960,{{ amp | plus: amp | minus: 5 }} 1440,{{ amp | minus: 5 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% elsif freq == 2 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,0 L0,{{ amp | minus: 10 }} Q360,{{ amp | plus: amp | minus: 10 }} 720,{{ amp | minus: 10 }} T1440,{{ amp | minus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,0 L0,{{ amp }} Q360,{{ amp | plus: amp }} 720,{{ amp }} T1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,0 L0,{{ amp | plus: 10 }} Q360,{{ amp | plus: amp | plus: 20 }} 720,{{ amp | plus: 10 }} T1440,{{ amp | plus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,0 L0,{{ amp }} L360,{{ amp | plus: amp }} L720,{{ amp }} L1080,{{ amp | plus: amp }} L1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,0 L0,{{ amp | minus: 5 }} C240,{{ amp | plus: amp | minus: 5 }} 480,{{ amp | plus: amp | minus: 5 }} 720,{{ amp | minus: 5 }} C960,{{ amp | minus: amp | minus: 5 }} 1200,{{ amp | minus: amp | minus: 5 }} 1440,{{ amp | minus: 5 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% elsif freq == 3 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,0 L0,{{ amp | minus: 10 }} Q240,{{ amp | plus: amp | minus: 10 }} 480,{{ amp | minus: 10 }} T960,{{ amp | minus: 10 }} T1440,{{ amp | minus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,0 L0,{{ amp }} Q240,{{ amp | plus: amp }} 480,{{ amp }} T960,{{ amp }} T1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,0 L0,{{ amp | plus: 10 }} Q240,{{ amp | plus: amp | plus: 20 }} 480,{{ amp | plus: 10 }} T960,{{ amp | plus: 10 }} T1440,{{ amp | plus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,0 L0,{{ amp }} L240,{{ amp | plus: amp }} L480,{{ amp }} L720,{{ amp | plus: amp }} L960,{{ amp }} L1200,{{ amp | plus: amp }} L1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,0 L0,{{ amp | minus: 5 }} C160,{{ amp | plus: amp | minus: 5 }} 320,{{ amp | plus: amp | minus: 5 }} 480,{{ amp | minus: 5 }} C640,{{ amp | minus: amp | minus: 5 }} 800,{{ amp | minus: amp | minus: 5 }} 960,{{ amp | minus: 5 }} C1120,{{ amp | plus: amp | minus: 5 }} 1280,{{ amp | plus: amp | minus: 5 }} 1440,{{ amp | minus: 5 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% elsif freq == 4 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,0 L0,{{ amp | minus: 10 }} Q180,{{ amp | plus: amp | minus: 10 }} 360,{{ amp | minus: 10 }} T720,{{ amp | minus: 10 }} T1080,{{ amp | minus: 10 }} T1440,{{ amp | minus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,0 L0,{{ amp }} Q180,{{ amp | plus: amp }} 360,{{ amp }} T720,{{ amp }} T1080,{{ amp }} T1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,0 L0,{{ amp | plus: 10 }} Q180,{{ amp | plus: amp | plus: 20 }} 360,{{ amp | plus: 10 }} T720,{{ amp | plus: 10 }} T1080,{{ amp | plus: 10 }} T1440,{{ amp | plus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,0 L0,{{ amp }} L180,{{ amp | plus: amp }} L360,{{ amp }} L540,{{ amp | plus: amp }} L720,{{ amp }} L900,{{ amp | plus: amp }} L1080,{{ amp }} L1260,{{ amp | plus: amp }} L1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,0 L0,{{ amp | minus: 5 }} C120,{{ amp | plus: amp | minus: 5 }} 240,{{ amp | plus: amp | minus: 5 }} 360,{{ amp | minus: 5 }} C480,{{ amp | minus: amp | minus: 5 }} 600,{{ amp | minus: amp | minus: 5 }} 720,{{ amp | minus: 5 }} C840,{{ amp | plus: amp | minus: 5 }} 960,{{ amp | plus: amp | minus: 5 }} 1080,{{ amp | minus: 5 }} C1200,{{ amp | minus: amp | minus: 5 }} 1320,{{ amp | minus: amp | minus: 5 }} 1440,{{ amp | minus: 5 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% else %}
              <path d="M0,0 L0,50 Q360,70 720,50 T1440,50 L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
            {% endif %}
          </svg>
        </div>
        <!-- strip B (clone) -->
        <div class="wave-strip" aria-hidden="true">
          <svg viewBox="0 0 1440 100" fill="none" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" role="presentation" focusable="false">
            {% assign freq = section.settings.wave_frequency %}
            {% assign amp = section.settings.wave_amplitude %}
            {% if freq == 1 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,0 L0,{{ amp | minus: 10 }} Q720,{{ amp | plus: amp | minus: 10 }} 1440,{{ amp | minus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,0 L0,{{ amp }} Q720,{{ amp | plus: amp }} 1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,0 L0,{{ amp | plus: 10 }} Q720,{{ amp | plus: amp | plus: 20 }} 1440,{{ amp | plus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,0 L0,{{ amp }} L720,{{ amp | plus: amp }} L1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,0 L0,{{ amp | minus: 5 }} C480,{{ amp | plus: amp | minus: 5 }} 960,{{ amp | plus: amp | minus: 5 }} 1440,{{ amp | minus: 5 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% elsif freq == 2 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,0 L0,{{ amp | minus: 10 }} Q360,{{ amp | plus: amp | minus: 10 }} 720,{{ amp | minus: 10 }} T1440,{{ amp | minus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,0 L0,{{ amp }} Q360,{{ amp | plus: amp }} 720,{{ amp }} T1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,0 L0,{{ amp | plus: 10 }} Q360,{{ amp | plus: amp | plus: 20 }} 720,{{ amp | plus: 10 }} T1440,{{ amp | plus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,0 L0,{{ amp }} L360,{{ amp | plus: amp }} L720,{{ amp }} L1080,{{ amp | plus: amp }} L1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,0 L0,{{ amp | minus: 5 }} C240,{{ amp | plus: amp | minus: 5 }} 480,{{ amp | plus: amp | minus: 5 }} 720,{{ amp | minus: 5 }} C960,{{ amp | minus: amp | minus: 5 }} 1200,{{ amp | minus: amp | minus: 5 }} 1440,{{ amp | minus: 5 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% elsif freq == 3 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,0 L0,{{ amp | minus: 10 }} Q240,{{ amp | plus: amp | minus: 10 }} 480,{{ amp | minus: 10 }} T960,{{ amp | minus: 10 }} T1440,{{ amp | minus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,0 L0,{{ amp }} Q240,{{ amp | plus: amp }} 480,{{ amp }} T960,{{ amp }} T1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,0 L0,{{ amp | plus: 10 }} Q240,{{ amp | plus: amp | plus: 20 }} 480,{{ amp | plus: 10 }} T960,{{ amp | plus: 10 }} T1440,{{ amp | plus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,0 L0,{{ amp }} L240,{{ amp | plus: amp }} L480,{{ amp }} L720,{{ amp | plus: amp }} L960,{{ amp }} L1200,{{ amp | plus: amp }} L1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,0 L0,{{ amp | minus: 5 }} C160,{{ amp | plus: amp | minus: 5 }} 320,{{ amp | plus: amp | minus: 5 }} 480,{{ amp | minus: 5 }} C640,{{ amp | minus: amp | minus: 5 }} 800,{{ amp | minus: amp | minus: 5 }} 960,{{ amp | minus: 5 }} C1120,{{ amp | plus: amp | minus: 5 }} 1280,{{ amp | plus: amp | minus: 5 }} 1440,{{ amp | minus: 5 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% elsif freq == 4 %}
              {% case section.settings.wave_shape %}
                {% when 'gentle' %}<path d="M0,0 L0,{{ amp | minus: 10 }} Q180,{{ amp | plus: amp | minus: 10 }} 360,{{ amp | minus: 10 }} T720,{{ amp | minus: 10 }} T1080,{{ amp | minus: 10 }} T1440,{{ amp | minus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'medium' %}<path d="M0,0 L0,{{ amp }} Q180,{{ amp | plus: amp }} 360,{{ amp }} T720,{{ amp }} T1080,{{ amp }} T1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'dramatic' %}<path d="M0,0 L0,{{ amp | plus: 10 }} Q180,{{ amp | plus: amp | plus: 20 }} 360,{{ amp | plus: 10 }} T720,{{ amp | plus: 10 }} T1080,{{ amp | plus: 10 }} T1440,{{ amp | plus: 10 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'sharp' %}<path d="M0,0 L0,{{ amp }} L180,{{ amp | plus: amp }} L360,{{ amp }} L540,{{ amp | plus: amp }} L720,{{ amp }} L900,{{ amp | plus: amp }} L1080,{{ amp }} L1260,{{ amp | plus: amp }} L1440,{{ amp }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
                {% when 'rounded' %}<path d="M0,0 L0,{{ amp | minus: 5 }} C120,{{ amp | plus: amp | minus: 5 }} 240,{{ amp | plus: amp | minus: 5 }} 360,{{ amp | minus: 5 }} C480,{{ amp | minus: amp | minus: 5 }} 600,{{ amp | minus: amp | minus: 5 }} 720,{{ amp | minus: 5 }} C840,{{ amp | plus: amp | minus: 5 }} 960,{{ amp | plus: amp | minus: 5 }} 1080,{{ amp | minus: 5 }} C1200,{{ amp | minus: amp | minus: 5 }} 1320,{{ amp | minus: amp | minus: 5 }} 1440,{{ amp | minus: 5 }} L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
              {% endcase %}
            {% else %}
              <path d="M0,0 L0,50 Q360,70 720,50 T1440,50 L1440,0 Z" fill="{{ section.settings.wave_color }}"/>
            {% endif %}
          </svg>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</section>

<style>
/* Foreground content container (matches the reference pattern) */
#shopify-section-{{ section.id }} .max-container{
  max-width:1280px;
  margin:0 auto;
  padding:80px 40px;
  box-sizing:border-box;
}

/* Positioning & waves (full-bleed) */
.features-wave-section { position: relative; overflow: visible; z-index: 1; }
.wave-top, .wave-bottom { position: absolute; left: 0; width: 100%; line-height: 0; pointer-events: none; z-index: 2; overflow: visible; }
.wave-top svg, .wave-bottom svg { width: 100%; height: 100%; display: block; }

/* Animation scaffolding */
.wave-bob { width: 100%; height: 100%; }
.is-bobbing.wave-bob--top { animation: wave-bob var(--wave-bob-speed) ease-in-out infinite; will-change: transform; }
.is-bobbing.wave-bob--bottom { animation: wave-bob-bottom var(--wave-bob-speed) ease-in-out infinite; will-change: transform; }
.wave-track { width: 200%; height: 100%; display: flex; will-change: transform; }
.wave-track.is-animating { animation: wave-scroll var(--wave-speed) linear infinite; }
.wave-track.is-animating.dir-right { animation-name: wave-scroll-reverse; }
.wave-strip { width: 50%; height: 100%; flex: 0 0 50%; }

/* Content wrapper */
.features-container { width: 100%; }

/* Title spacing (keep theme h3 font) */
#feed-title { font-weight: 600; margin: 0 0 24px 0; line-height: 1.2; }

/* -------- Instagram Carousel (scroll-snap like the reference) -------- */
.insta-carousel { position: relative; display: flex; align-items: center; gap: 12px; }

/* Horizontal track */
.insta-track {
  position: relative;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scroll-snap-type: x mandatory;
  display: flex;
  gap: {{ section.settings.card_gap }}px;  /* used by JS for nav step */
  padding: 6px;
  scroll-behavior: smooth;
  outline: none;
  scroll-padding-inline: 6px;
}

/* Placeholders row (so skeletons line up horizontally) */
.insta-skeletons { display: flex; gap: {{ section.settings.card_gap }}px; }

.insta-slide {
  scroll-snap-align: start;
  position: relative;
  border-radius: {{ section.settings.card_radius }}px;
  overflow: hidden;
  background: {{ section.settings.card_bg }};
  flex: 0 0 calc(100% / var(--vis)); /* exact # visible */
}

.insta-imgwrap { position: relative; width: 100%; aspect-ratio: 1 / 1; }
.insta-img { width: 100%; height: 100%; object-fit: cover; display: block; }

/* Prev/Next like reference arrows */
.insta-nav {
  background: #fff;
  border: 1px solid rgba(0,0,0,.1);
  border-radius: 999px;
  width: 42px; height: 42px;
  font-size: 18px; line-height: 40px;
  text-align: center;
  box-shadow: 0 6px 12px rgba(0,0,0,.08);
  cursor: pointer;
  user-select: none;
}
.insta-nav:disabled { opacity: .4; cursor: default; }

.insta-cta a { text-decoration: underline; }

/* Placeholder look */
.insta-slide.placeholder .insta-img { filter: grayscale(1); opacity: .9; }
.insta-slide.placeholder a { pointer-events: none; }

/* Keyframes */
@keyframes wave-scroll { from { transform: translateX(0); } to { transform: translateX(-50%); } }
@keyframes wave-scroll-reverse { from { transform: translateX(-50%); } to { transform: translateX(0); } }
@keyframes wave-bob { 0%,100% { transform: translateY(0); } 50% { transform: translateY(calc(var(--wave-bob) * -1)); } }
@keyframes wave-bob-bottom { 0%,100% { transform: translateY(0); } 50% { transform: translateY(var(--wave-bob)); } }

/* Mobile polish to mimic the referenced spacing */
@media (max-width: 576px){
  /* give last slide breathing room like the reference’s slider margins */
  .insta-track .insta-slide:last-child { margin-right: 24px; }
  /* force heading + CTA centered on small screens regardless of editor alignment */
  #feed-title, .insta-cta { text-align: center !important; }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  .wave-track.is-animating,
  .is-bobbing.wave-bob--top,
  .is-bobbing.wave-bob--bottom { animation: none !important; }
  .insta-track { scroll-behavior: auto; }
}
</style>

<script>
(function() {
  const root = document.currentScript.closest('section');
  const carousel = root.querySelector('.insta-carousel');
  const track = root.querySelector('#instaTrack-{{ section.id }}');
  const btnPrev = root.querySelector('.insta-nav--prev');
  const btnNext = root.querySelector('.insta-nav--next');

  // settings from schema
  const visDesktop = parseInt(carousel.dataset.visible, 10) || 4;
  const visTablet = parseInt(carousel.dataset.tablet, 10) || 3;
  const visMobile = parseInt(carousel.dataset.mobile, 10) || 2;
  const autoplay = carousel.dataset.autoplay === 'true';
  const autoplayInterval = parseInt(carousel.dataset.autoplayInterval, 10) || 4000;

  // set columns via CSS var (reference-like responsiveness)
  function setVis() {
    const w = window.innerWidth;
    let vis = visDesktop;
    if (w <= 990) vis = visTablet;
    if (w <= 749) vis = visMobile;
    track.style.setProperty('--vis', vis);
  }
  setVis();
  window.addEventListener('resize', setVis);

  // helper to compute a single slide step (width + gap)
  function getStep() {
    const vis = parseFloat(getComputedStyle(track).getPropertyValue('--vis')) || visDesktop;
    const slideWidth = track.clientWidth / vis;
    const styles = getComputedStyle(track);
    const gap = parseFloat(styles.gap || styles.columnGap || '0');
    return slideWidth + gap;
  }

  // enable/disable arrows at edges (like carousel UX)
  function updateArrows() {
    const maxScroll = track.scrollWidth - track.clientWidth - 1;
    btnPrev.disabled = track.scrollLeft <= 0;
    btnNext.disabled = track.scrollLeft >= maxScroll;
  }
  track.addEventListener('scroll', updateArrows);
  window.addEventListener('resize', updateArrows);
  updateArrows();

  // basic nav
  function scrollBySlides(dir) {
    track.scrollBy({ left: dir * getStep(), behavior: 'smooth' });
  }
  btnPrev.addEventListener('click', () => scrollBySlides(-1));
  btnNext.addEventListener('click', () => scrollBySlides(1));

  // keyboard support
  track.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') { e.preventDefault(); scrollBySlides(-1); }
    if (e.key === 'ArrowRight') { e.preventDefault(); scrollBySlides(1); }
  });

  // autoplay
  let timer = null;
  function startAutoplay() {
    if (!autoplay) return;
    stopAutoplay();
    timer = setInterval(() => scrollBySlides(1), autoplayInterval);
  }
  function stopAutoplay() { if (timer) clearInterval(timer); timer = null; }
  track.addEventListener('mouseenter', stopAutoplay);
  track.addEventListener('mouseleave', startAutoplay);
  startAutoplay();

  // ---- Instagram fetching via proxy ----
  const proxyUrl = {{ section.settings.proxy_url | json }}; // e.g. "/apps/instagram-feed?user_id=XXXXX&access_token=YYYYY"
  const maxItems = {{ section.settings.max_items | json }};
  const openInNew = true;

  async function fetchFromProxy(url) {
    const res = await fetch(url, { credentials: 'same-origin' });
    if (!res.ok) throw new Error('Failed to load Instagram feed');
    return res.json();
  }

  function normalizeItems(json) {
    // expects { data: [{ media_type, media_url, thumbnail_url, permalink, timestamp, caption }], paging?: {...} }
    if (!json || !Array.isArray(json.data)) return [];
    return json.data.map(item => {
      const isVideo = item.media_type === 'VIDEO' || item.media_type === 'REEL';
      const url = isVideo ? (item.thumbnail_url || item.media_url) : item.media_url;
      return {
        img: url,
        href: item.permalink || '#',
        alt: (item.caption || 'Instagram image').slice(0, 140)
      };
    }).filter(x => !!x.img);
  }

  async function loadInstagram() {
    if (!proxyUrl) return;
    try {
      let out = [];
      const first = await fetchFromProxy(proxyUrl);
      out = out.concat(normalizeItems(first));
      if (maxItems && out.length > maxItems) out = out.slice(0, maxItems);

      // Remove placeholders only (keep track)
      const sk = track.querySelector('.insta-skeletons');
      if (sk) sk.remove();

      // Render slides
      if (!out.length) {
        track.innerHTML = '<p style="opacity:.7;padding:12px;">No Instagram posts to display.</p>';
        updateArrows();
        return;
      }
      const frag = document.createDocumentFragment();
      out.forEach(it => {
        const slide = document.createElement('div');
        slide.className = 'insta-slide';
        slide.setAttribute('role', 'option');

        const a = document.createElement('a');
        a.href = it.href;
        if (openInNew) { a.target = '_blank'; a.rel = 'noopener nofollow'; }
        a.setAttribute('aria-label', 'Open Instagram post');

        const wrap = document.createElement('div');
        wrap.className = 'insta-imgwrap';

        const img = document.createElement('img');
        img.className = 'insta-img';
        img.loading = 'lazy';
        img.decoding = 'async';
        img.alt = it.alt;
        img.src = it.img;

        wrap.appendChild(img);
        a.appendChild(wrap);
        slide.appendChild(a);
        frag.appendChild(slide);
      });
      track.appendChild(frag);
      updateArrows();
    } catch (e) {
      console.error(e);
      const status = document.createElement('p');
      status.style.opacity = '.7';
      status.style.padding = '12px 0 0';
      status.textContent = 'Unable to load Instagram feed right now.';
      carousel.parentElement.appendChild(status);
    }
  }

  loadInstagram();
})();
</script>

{% schema %}
{
  "name": "IG Waves Feed",
  "settings": [
    { "type": "checkbox", "id": "use_gradient", "label": "Use Gradient Background", "default": true },
    { "type": "color", "id": "background_color", "label": "Background Color", "default": "#FFE9ED" },
    { "type": "color_background", "id": "background_gradient", "label": "Background Gradient", "default": "linear-gradient(0deg, #ffe0e6 0%, #ffd7dc 100%)" },

    { "type": "range", "id": "section_padding_top", "label": "Padding Top (outer)", "min": 0, "max": 250, "step": 10, "default": 0 },
    { "type": "range", "id": "section_padding_bottom", "label": "Padding Bottom (outer)", "min": 0, "max": 250, "step": 10, "default": 0 },

    { "type": "range", "id": "container_width", "label": "Inner Container Max Width (unused, fixed to 1280)", "min": 800, "max": 1600, "step": 20, "default": 1280 },

    { "type": "text", "id": "section_title", "label": "Heading", "default": "Follow us on Instagram" },
    { "type": "color", "id": "title_color", "label": "Heading Color", "default": "#7b1d2a" },
    { "type": "select", "id": "title_alignment", "label": "Heading Alignment", "options": [{"value":"left","label":"Left"},{"value":"center","label":"Center"},{"value":"right","label":"Right"}], "default": "center" },

    { "type": "header", "content": "Instagram Source" },
    { "type": "text", "id": "proxy_url", "label": "Proxy URL (server endpoint)", "default": "/apps/instagram-feed?user_id=YOUR_ID&access_token=YOUR_TOKEN", "info": "Must return Instagram JSON from the Basic Display API." },
    { "type": "text", "id": "instagram_profile_url", "label": "Instagram Profile URL (optional CTA link)", "default": "https://instagram.com/yourhandle" },
    { "type": "checkbox", "id": "show_view_on_ig", "label": "Show 'View on Instagram' link", "default": true },

    { "type": "header", "content": "Carousel" },
    { "type": "range", "id": "carousel_desktop", "label": "Visible on Desktop", "min": 2, "max": 8, "step": 1, "default": 4 },
    { "type": "range", "id": "carousel_tablet", "label": "Visible on Tablet", "min": 2, "max": 6, "step": 1, "default": 3 },
    { "type": "range", "id": "carousel_mobile", "label": "Visible on Mobile", "min": 1, "max": 4, "step": 1, "default": 2 },
    { "type": "checkbox", "id": "autoplay", "label": "Autoplay", "default": false },
    { "type": "range", "id": "autoplay_interval", "label": "Autoplay Interval (ms)", "min": 1500, "max": 9000, "step": 500, "default": 4000 },

    { "type": "header", "content": "Cards" },
    { "type": "color", "id": "card_bg", "label": "Card Background", "default": "#FFFFFF" },
    { "type": "range", "id": "card_radius", "label": "Card Corner Radius", "min": 8, "max": 36, "step": 1, "default": 18 },
    { "type": "range", "id": "card_gap", "label": "Gap Between Slides", "min": 8, "max": 36, "step": 1, "default": 16 },

    { "type": "header", "content": "Data" },
    { "type": "range", "id": "max_items", "label": "Max posts to display", "min": 4, "max": 100, "step": 1, "default": 20 },

    { "type": "header", "content": "Wave Settings" },
    { "type": "select", "id": "wave_shape", "label": "Wave Shape", "options": [{"value":"gentle","label":"Gentle"},{"value":"medium","label":"Medium"},{"value":"dramatic","label":"Dramatic"},{"value":"sharp","label":"Sharp"},{"value":"rounded","label":"Rounded"}], "default": "medium" },
    { "type": "checkbox", "id": "show_top_wave", "label": "Show Top Wave", "default": true },
    { "type": "checkbox", "id": "show_bottom_wave", "label": "Show Bottom Wave", "default": true },
    { "type": "color", "id": "wave_color", "label": "Wave Color", "default": "#FFD4E5" },
    { "type": "range", "id": "wave_overlap_top", "label": "Top Wave Height", "min": 20, "max": 200, "step": 10, "default": 120 },
    { "type": "range", "id": "wave_overlap_bottom", "label": "Bottom Wave Height", "min": 20, "max": 200, "step": 10, "default": 120 },
    { "type": "range", "id": "wave_frequency", "label": "Wave Frequency", "min": 1, "max": 4, "step": 1, "default": 2 },
    { "type": "range", "id": "wave_amplitude", "label": "Wave Amplitude", "min": 10, "max": 40, "step": 5, "default": 25 },

    { "type": "header", "content": "Wave Animation" },
    { "type": "checkbox", "id": "enable_wave_animation", "label": "Enable Wave Animation", "default": true },
    { "type": "range", "id": "wave_scroll_speed", "label": "Horizontal Scroll Speed (s)", "min": 4, "max": 40, "step": 1, "default": 14 },
    { "type": "range", "id": "wave_bob_amount", "label": "Bob Amount (px)", "min": 0, "max": 20, "step": 1, "default": 6 },
    { "type": "range", "id": "wave_bob_speed", "label": "Bob Speed (s)", "min": 2, "max": 20, "step": 1, "default": 7 },
    { "type": "select", "id": "wave_direction", "label": "Scroll Direction", "options": [{"value":"left","label":"Left"},{"value":"right","label":"Right"}], "default": "left" }
  ],
  "blocks": [],
  "presets": [{ "name": "IG Waves Feed" }]
}
{% endschema %}
